<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Maps Places API</title>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJemXCMNrZpUdz5r6CmnlzdfHcelWc84o&libraries=drawing,places,geometry"></script>
    <script>
        let map, placesService, infowindow;

        function initMap() {
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 6.009, lng: 116.008 },
                zoom: 17,
            });
            //그린 경로의 좌표를 지정할 변수
            var drawnPathCoordinates = [
                // {lat:6.007927675392611, lng:116.0071899728775},
                // {lat:6.007714277208789, lng:116.00770495700836}
            ];

            //선을 그리기 위한 google의 DrawingManager를 초기화
            const drawingManager = new google.maps.drawing.DrawingManager({
                //기본 drawingMode 지정, Control로 Options에 대해 변경 가능하게 설정
                drawingMode: google.maps.drawing.OverlayType.POLYLINE,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        //   google.maps.drawing.OverlayType.MARKER,
                        //   google.maps.drawing.OverlayType.CIRCLE,
                        //   google.maps.drawing.OverlayType.POLYGON,
                        google.maps.drawing.OverlayType.POLYLINE,
                        //   google.maps.drawing.OverlayType.RECTANGLE,
                    ],
                },
                polylineOptions: {
                    editable: true,
                },
                //marker와 cicle에 대한 추가 옵션
                //   markerOptions: {
                //     icon: "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png",
                //   },
                //   circleOptions: {
                //     fillColor: "#ffff00",
                //     fillOpacity: 1,
                //     strokeWeight: 5,
                //     clickable: false,
                //     editable: true,
                //     zIndex: 1,
                //   },
            });
            //지도에 드로잉 매니저 등록
            drawingManager.setMap(map);

            //POLYLINE(선 그리기) 완료될 때 동작하는 이벤트 리스너 추가(이벤트명, 실행할 함수명, 옵션)
            google.maps.event.addListener(
                drawingManager,
                "polylinecomplete",
                function (polyline) {
                    //좌표를 변수에 저장
                    drawnPathCoordinates = polyline.getPath().getArray();

                    console.log("Drawn path coordinates:", drawnPathCoordinates);
                    console.log(drawnPathCoordinates[0]);
                    console.log(JSON.stringify(drawnPathCoordinates[0]));

                }
            );

            // 저장된 좌표를 사용하여 지도에 선 그리기
            function drawPolylineOnMap(coordinates) {
                // Polyline을 그릴 때 사용할 스타일 설정
                var polylineOptions = {
                    path: coordinates,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                };

                // Polyline 객체 생성
                var polyline = new google.maps.Polyline(polylineOptions);

                // Polyline을 지도에 추가
                polyline.setMap(map);
            }

            // 예제: 저장된 좌표를 사용하여 지도에 선 그리기
            drawPolylineOnMap(drawnPathCoordinates);

            placesService = new google.maps.places.PlacesService(map);
            infowindow = new google.maps.InfoWindow();

            // 현재 위치를 얻어옵니다.
            //navigator : window 객체의 property
            //geolocation : 사용자의 지리적 위치 정보를 확인하는 API
            //navigator.geolocation을 동작시 브라우저에 정보 수집 팝업이 발생하며, 수락할 경우 하위 코드가 동작한다.
            if (navigator.geolocation) {
                //getCurrentPosition : 사용자의 현재 위치를 요청한다.
                navigator.geolocation.getCurrentPosition(
                    //position에 들어있는 정보들 중 위도와 경도를 추출해 lat, lng에 저장
                    (position) => {
                        const currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        //해당 위도 경로로 map을 위치
                        map.setCenter(currentLocation);

                        // 건물 이름을 검색하고 현재 위치에서 가장 가까운 건물만을 표시합니다.
                        document
                            .getElementById("searchButton")
                            .addEventListener("click", () => {
                                const keyword = document.getElementById("searchInput").value;
                                searchNearbyPlaces(keyword, currentLocation);
                            });
                    },
                    (error) => {
                        console.error("Error getting current location:", error);
                    }
                );
            }
        }

        //현재 위치와 검색 키워드를 입력 받음
        function searchNearbyPlaces(keyword, currentLocation) {
            const request = {
                location: currentLocation,
                //   radius: 500, // 500미터 반경 내에서 검색
                query: keyword,
            };

            //PlacesServie 클래스 : 장소 검색 및 장소 세부정보 검색 관련 메서드를 포함
            //request 파라미터를 받고, (results, status) 콜백 함수를 추가하여 가장 가까운 좌표만 추출
            //callback: function(Array<PlaceResult> optional, PlacesServiceStatus, PlaceSearchPagination optional): void
            placesService.textSearch(request, (results, status) => {
                //google.maps.places.PlacesServiceStatus : 검색 완료 시 PlacesService에서 반환한 상태로 값 또는 상수 이름을 사용하여 지정
                //OK는 상수로 응답에 유요한 결과가 포함되어 있음을 뜻함. 즉 검색 결과가 유효한 경우 하위 코드 동작
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    // 거리순으로 정렬 후, 가장 가까운 좌표만을 표시합니다.
                    const closestPlace = findClosestPlace(results, currentLocation);
                    if (closestPlace) {
                        showInfoWindow(closestPlace, currentLocation);
                    } else {
                        console.error("No results found");
                    }
                } else {
                    console.error("Place search failed. Status:", status);
                }
            });
        }
        function findClosestPlace(places, currentLocation) {
            //Array에 들어가있는 좌표들이 현재 좌표로 부터 거리가 0이라면 null
            if (places.length === 0) {
                return null;
            }

            // 결과를 거리순으로 정렬합니다.
            places.sort((a, b) => {
                //places에 length가 있는데 굳이 필요한지?
                //   const distanceA =
                //     google.maps.geometry.spherical.computeDistanceBetween(
                //       new google.maps.LatLng(currentLocation),
                //       new google.maps.LatLng(
                //         a.geometry.location.lat(),
                //         a.geometry.location.lng()
                //       )
                //     );

                //   const distanceB =
                //     google.maps.geometry.spherical.computeDistanceBetween(
                //       new google.maps.LatLng(currentLocation),
                //       new google.maps.LatLng(
                //         b.geometry.location.lat(),
                //         b.geometry.location.lng()
                //       )
                //     );

                //   return distanceA - distanceB;
                return a.length - b.length;
            });

            return places[0];
        }

        function showInfoWindow(place, currentLocation) {
            // 기존 마커를 제거합니다.
            clearMarkers();

            const marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: place.name,
            });

            // 마커에 정보 창을 추가합니다.
            infowindow.setContent(
                `<strong>${place.name}</strong><br>${place.formatted_address}`
            );
            infowindow.open(map, marker);

            // 새로운 마커를 저장합니다.
            markers.push(marker);
        }

        function clearMarkers() {
            // 이전 마커를 제거합니다.
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        let markers = [];
    </script>
</head>

<body onload="initMap()">
    <div>
        <input type="text" id="searchInput" placeholder="Enter building name" />
        <button id="searchButton">Search</button>
    </div>
    <div id="map" style="height: 500px"></div>
</body>

</html>